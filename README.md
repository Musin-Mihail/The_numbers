# The Numbers - Unity WebGL игра для Яндекс.Игр

Этот документ описывает архитектуру и внутреннее устройство игры "The Numbers", разработанной на Unity для платформы Яндекс.Игры.


## Об игре

"The Numbers" — это логическая игра-головоломка, где цель игрока — очистить игровое поле, находя пары чисел. Пара считается совпавшей, если:

1. Числа в ячейках одинаковы.

2. Сумма чисел в ячейках равна 10.

3. Между ячейками нет других активных ячеек по горизонтали, вертикали или при последовательном чтении всех чисел на поле.

Игра интегрирована с сервисами Яндекс.Игр, включая сохранение прогресса, таблицу лидеров и внутриигровые покупки.


## Архитектура

Проект построен на основе принципов, близких к **Model-View-Controller (MVC)**, с сильным акцентом на разделение данных, логики и представления.

- **Model**: Слой данных, не зависящий от Unity. Содержит всю информацию о состоянии игры: сетку (`GridModel`), статистику (`StatisticsModel`), счетчики действий (`ActionCountersModel`).

- **View**: Слой представления, реализованный на компонентах Unity UI. Отвечает за отображение данных из модели и обработку пользовательского ввода. `GridView` является центральным компонентом, управляющим визуализацией сетки.

- **Controller**: Слой логики. `GameController` координирует взаимодействие между моделью и представлением, обрабатывая основные игровые циклы. Дополнительные обработчики (`MatchHandler`, `PlayerActionHandler` и др.) отвечают за конкретные игровые механики.

Для управления зависимостями используется простой **Service Locator** (`ServiceProvider`), который позволяет регистрировать и получать сервисы из любой точки приложения.

Взаимодействие между системами построено на **системе событий** на базе `ScriptableObject` (`GameEvents`). Это позволяет создавать слабую связь между компонентами, что упрощает их тестирование и модификацию.


## Ключевые системы

### 1. Ядро (Core)

- `GameBootstrap`: Точка входа в игру. Инициализирует все основные сервисы, модели и контроллеры, регистрирует их в `ServiceProvider` и внедряет зависимости. Также управляет процессом загрузки сохранений с несколькими попытками.

- `GameController`: Центральный оркестратор игровой логики. Принимает решения о начале новой игры, управляет дочерними обработчиками (`MatchHandler`, `HintHandler`, `PlayerActionHandler`).

- `GameManager`: Управляет глобальными состояниями, такими как сохранение игры по таймеру и при определенных действиях.


### 2. Модель (Model)

- `GridModel`: Хранит состояние всей игровой сетки в виде списка списков `CellData`. Управляет добавлением, удалением и изменением состояния ячеек. Кэширует список активных ячеек для оптимизации.

- `StatisticsModel`: Хранит счет и текущий множитель очков.

- `ActionCountersModel`: Управляет количеством доступных действий (отмена хода, добавление чисел, подсказки). Поддерживает режим отключенных ограничений (после покупки).


### 3. Представление (View)

- `GridView`: Главный компонент, отвечающий за визуализацию сетки. Он не содержит сложной логики, а делегирует задачи специализированным классам:

  - `GridInputHandler`: Обрабатывает клики по ячейкам.

  - `GridVisuals`: Управляет визуальными эффектами (выделение, подсветка, всплывающие очки).

  - `GridLayoutManager`: Рассчитывает позиции ячеек, управляет размером и прокруткой контента.

- **Пул объектов (`CellPool`, `FloatingScorePool`)**: Для оптимизации производительности и минимизации создания/уничтожения объектов в рантайме используются пулы для ячеек и всплывающих текстов с очками.

- **UI Компоненты**: `ActionCountersView`, `StatisticsView`, `LeaderboardView` и другие классы отвечают за отображение конкретных частей интерфейса и подписываются на события из `GameEvents` для обновления.


### 4. Игровой процесс (Gameplay)

- `MatchValidator`: Содержит логику проверки, является ли пара ячеек допустимым совпадением согласно правилам игры. Он полностью отделен от представления и работает только с данными, которые ему предоставляет `IGridDataProvider`.


### 5. Интеграция с Yandex Games

- `YandexSaveLoadService`: Реализует интерфейс `ISaveLoadService`. Отвечает за сериализацию моделей (`GridModel`, `StatisticsModel` и др.) в специальный класс `SavesYG` и их сохранение/загрузку через плагин Yandex Games.

- `YandexLeaderboardService`: Отправляет счет игрока в таблицу лидеров.

- `YandexPlatformService`: Управляет внутриигровыми покупками и показом рекламы с вознаграждением. Является мостом между игровыми событиями и API плагина.


### 6. Система отмены (Undo System)

- `ActionHistory`: Хранит стек действий, которые можно отменить (`IUndoableAction`).

- `MatchAction`: Реализация `IUndoableAction` для действия совпадения пары. Хранит всю необходимую информацию для восстановления состояния игры до этого действия: состояние ячеек, удаленные линии, счет и множитель.


## Структура проекта (папки Scripts)

- **Core**: Основные классы, управляющие жизненным циклом игры (`GameBootstrap`, `GameController`, `GameManager`), система событий, Service Locator и обработчики (`Handlers`).

- **DataProviders**: Классы, предоставляющие данные для других систем (например, `GridDataProvider`).

- **Gameplay**: Классы, описывающие правила и логику игры (`MatchValidator`).

- **Interfaces**: Абстракции для ключевых сервисов (`ISaveLoadService`, `ILeaderboardService` и т.д.), обеспечивающие слабую связность.

- **Model**: Классы, описывающие состояние игровых данных (`GridModel`, `CellData`, `StatisticsModel`).

- **Services**: Вспомогательные сервисы (например, `ImageDownloader`).

- **View**: Все, что связано с визуальным представлением: управление сеткой, UI, анимациями.

- **YG**: Классы для взаимодействия с плагином Yandex Games, включая структуру сохранений `SavesYG`.

- **Editor**: Скрипты для редактора Unity, например, `ScriptUsageReporter`.
